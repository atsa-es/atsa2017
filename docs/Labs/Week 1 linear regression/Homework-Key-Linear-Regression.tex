\input{../tex/headerfile}
\input{../tex/mathdefs}
\setcounter{MaxMatrixCols}{20}
\usepackage{enumerate}
\usepackage{Sweave}
\begin{document}
\input{Homework-Key-Linear-Regression-concordance}



\chapter{Linear regression models in matrix form}
\label{chap:mlr}
\chaptermark{Linear regression}

This chapter shows how to write linear regression models in matrix form. The purpose is to get you comfortable writing multivariate linear models in different matrix forms before we start working with time-series versions of these models.  Each matrix form is an equivalent model for the data, but written in different forms.  You do not need to worry which form is better or worse at this point.  Simply get comfortable writing multivariate linear models in different matrix forms.

We will work with the \verb@stackloss@ dataset available in R.  The \verb@stackloss@ dataset consists of 21 observations on the efficiency of a plant that produces nitric acid as a function of three explanatory variables: air flow, water temperature and acid concentration.  We are going to use just the first 4 datapoints so that it is easier to write the matrices, but the concepts extend to as many datapoints as you have
\begin{Schunk}
\begin{Sinput}
 data(stackloss)
 dat = stackloss[1:4,] #subsetted first 4 rows
 dat
\end{Sinput}
\begin{Soutput}
  Air.Flow Water.Temp Acid.Conc. stack.loss
1       80         27         89         42
2       80         27         88         37
3       75         25         90         37
4       62         24         87         28
\end{Soutput}
\end{Schunk}

We will start by regressing stack loss against air flow.  In R using the \verb@lm@ function this is
\begin{Schunk}
\begin{Sinput}
 require(stats)
 lm(stack.loss ~ Air.Flow, data=dat)
\end{Sinput}
\end{Schunk}

This fits the following model for the $i$-th measurment:
\begin{equation}\label{eqn:stacklossi}
stack.loss_i = \alpha + \beta air_i + e_i, \text{ where } e_i \sim \N(0,\sigma^2) 
\end{equation}
We will write the model for all the measurements together in two different ways, Form 1 and Form 2.

\section{Form 1}
In this form, we have the explanatory variables in a matrix on the left of our parameter matrix:
\begin{equation}\label{eqn:stackloss.form1}
\begin{gathered}
\begin{bmatrix}stack.loss_1\\stack.loss_2\\stack.loss_3\\stack.loss_4\end{bmatrix}
= 
\begin{bmatrix}1&air_1\\1&air_2\\1&air_3\\1&air_4\end{bmatrix}
\begin{bmatrix}\alpha\\ \beta\end{bmatrix}
+
\begin{bmatrix}e_1\\e_2\\e_3\\e_4\end{bmatrix}
\end{gathered}
\end{equation}
You should work through the matrix algebra to make sure you understand why Equation \ref{eqn:stackloss.form1} is Equation \ref{eqn:stacklossi} for all the $i$ data points together.


We can write the first line of Equation \ref{eqn:stackloss.form1} succinctly as
\begin{equation}
\yy = \ZZ\xx + \ee
\end{equation}
where $\xx$ are our parameters, $\yy$ are our response variables, and $\ZZ$ are our explanatory variables (with a 1 column for the intercept).  The \verb@lm()@ function uses Form 1, and we can recover the $\ZZ$ matrix for Form 1 by using the \verb@model.matrix()@ function on the output from a \verb@lm@ call:
\begin{Schunk}
\begin{Sinput}
 fit=lm(stack.loss ~ Air.Flow, data=dat)
 Z=model.matrix(fit)
 Z[1:4,]
\end{Sinput}
\begin{Soutput}
  (Intercept) Air.Flow
1           1       80
2           1       80
3           1       75
4           1       62
\end{Soutput}
\end{Schunk}

\subsection{Solving for the parameters*}\label{solveform1}
\textit{You will not need to know how to solve linear matrix equations for this course.  This section just shows you what the \texttt{lm} function is doing to give you the parameters.}

Notice that $\ZZ$ is not a square matrix and its inverse does not exist but the inverse of $\ZZ^\top\ZZ$ exists---if this is a solveable problem.  We can go through the following steps to solve for $\xx$, our parameters $\alpha$ and $\beta$.
\begin{equation}\label{eqn:stack.loss.derivation}
\begin{gathered}
\text{Start with }\yy = \ZZ\xx + \ee \text{ and multiply by }\ZZ^\top\text{ on the left to get}\\
\ZZ^\top\yy = \ZZ^\top\ZZ\xx + \ZZ^\top\ee\\
\text{Multiply that by }(\ZZ^\top\ZZ)^{-1}\text{ on the left}\\
(\ZZ^\top\ZZ)^{-1}\ZZ^\top\yy = (\ZZ^\top\ZZ)^{-1}\ZZ^\top\ZZ\xx + (\ZZ^\top\ZZ)^{-1}\ZZ^\top\ee\\
(\ZZ^\top\ZZ)^{-1}\ZZ^\top\ZZ \text{ equals the identity matrix}\\
(\ZZ^\top\ZZ)^{-1}\ZZ^\top\yy = \xx + (\ZZ^\top\ZZ)^{-1}\ZZ^\top\ee\\
\text{Move the }\xx\text{ to the right by itself}\\
(\ZZ^\top\ZZ)^{-1}\ZZ^\top\yy - (\ZZ^\top\ZZ)^{-1}\ZZ^\top\ee = \xx
\end{gathered}
\end{equation}

Let's assume our errors, the $\ee$, are i.i.d. which means that
\begin{equation}
\ee \sim \MVN\begin{pmatrix}0,
\begin{bmatrix}
\sigma^2&0&0&0\\ 0&\sigma^2&0&0\\ 0&0&\sigma^2&0\\ 0&0&0&\sigma^2
\end{bmatrix}
\end{pmatrix}
\end{equation}
This equation means ``$\ee$ is drawn from a multivariate normal distribution with a variance-covariance matrix that is diagonal with equal variances.''
Under that assumption, the expected value of $(\ZZ^\top\ZZ)^{-1}\ZZ^\top\ee$ is zero.  So we can solve for $\xx$ as
$$\xx = (\ZZ^\top\ZZ)^{-1}\ZZ^\top\yy$$

Let's try that with R and compare to what you get with \verb@lm@:
\begin{Schunk}
\begin{Sinput}
 y=matrix(dat$stack.loss, ncol=1)
 Z=cbind(1,dat$Air.Flow) #or use model.matrix() to get Z
 solve(t(Z)%*%Z)%*%t(Z)%*%y
\end{Sinput}
\begin{Soutput}
            [,1]
[1,] -11.6159170
[2,]   0.6412918
\end{Soutput}
\begin{Sinput}
 coef(lm(stack.loss ~ Air.Flow, data=dat))
\end{Sinput}
\begin{Soutput}
(Intercept)    Air.Flow 
-11.6159170   0.6412918 
\end{Soutput}
\end{Schunk}
As you see, you get the same values.

\subsection{Form 1 with multiple explanatory variables}

We can easily extend Form 1 to multiple explanatory variables.  Let's say we wanted to fit this model:
\begin{equation}\label{eqn:stacklossi.mult}
stack.loss_i = \alpha + \beta_1 air_i + \beta_2 water_i + \beta_3 acid_i + e_i 
\end{equation}
With \verb@lm@, we can fit this with
\begin{Schunk}
\begin{Sinput}
 fit1.mult=lm(stack.loss ~ Air.Flow + Water.Temp + Acid.Conc., data=dat)
\end{Sinput}
\end{Schunk}
Written in matrix form (Form 1), this is
\begin{equation}\label{eqn:stackloss.form1.mult}
\begin{gathered}
\begin{bmatrix}stack.loss_1\\stack.loss_2\\stack.loss_3\\stack.loss_4\end{bmatrix}
= 
\begin{bmatrix}1&air_1&water_1&acid_1\\1&air_2&water_2&acid_2\\1&air_3&water_3&acid_3\\1&air_4&water_4&acid_4\end{bmatrix}
\begin{bmatrix}\alpha\\ \beta_1 \\ \beta_2 \\ \beta_3\end{bmatrix}
+
\begin{bmatrix}e_1\\e_2\\e_3\\e_4\end{bmatrix}
\end{gathered}
\end{equation}
Now $\ZZ$ is a matrix with 4 columns and $\xx$ is a column vector with 4 rows.  We can show the $\ZZ$ matrix again directly from our \verb@lm@ fit:
\begin{Schunk}
\begin{Sinput}
 Z=model.matrix(fit1.mult)
 Z
\end{Sinput}
\begin{Soutput}
  (Intercept) Air.Flow Water.Temp Acid.Conc.
1           1       80         27         89
2           1       80         27         88
3           1       75         25         90
4           1       62         24         87
attr(,"assign")
[1] 0 1 2 3
\end{Soutput}
\end{Schunk}


We can solve for $\xx$ just like before and compare to what we get with \verb@lm@:
\begin{Schunk}
\begin{Sinput}
 y=matrix(dat$stack.loss, ncol=1)
 Z=cbind(1,dat$Air.Flow, dat$Water.Temp, dat$Acid.Conc)
 #or Z=model.matrix(fit2)
 solve(t(Z)%*%Z)%*%t(Z)%*%y
\end{Sinput}
\begin{Soutput}
            [,1]
[1,] -524.904762
[2,]   -1.047619
[3,]    7.619048
[4,]    5.000000
\end{Soutput}
\begin{Sinput}
 coef(fit1.mult)
\end{Sinput}
\begin{Soutput}
(Intercept)    Air.Flow  Water.Temp  Acid.Conc. 
-524.904762   -1.047619    7.619048    5.000000 
\end{Soutput}
\end{Schunk}
Take a look at the $\ZZ$ we made in R.  It looks exactly like what is in our model written in matrix form (Equation \ref{eqn:stackloss.form1.mult}).

\subsection{When does Form 1 arise?}

This form of writing a regression model will come up when you work with dynamic linear models (DLMs).  With DLMs, you will be fitting models of the form $\yy_t=\ZZ_t\xx_t+\ee_t$.  In these models you have multiple $\yy$ at regular time points and you allow your regression parameters, the $\xx$, to evolve through time as a random walk.

\subsection{Form 1b: The transpose of Form 1}\label{solveform1b}
We could also write Form 1 as follows:
\begin{equation}\label{eqn:stackloss.form1b} 
\begin{split}
\begin{bmatrix}stack.loss_1&stack.loss_2&stack.loss_3 &stack.loss_4\end{bmatrix}
= \\
\begin{bmatrix}\alpha& \beta_1 & \beta_2 & \beta_3 \end{bmatrix}
\begin{bmatrix}1&1&1&1\\air_1&air_2&air_3&air_4\\wind_1&wind_2&wind_3&wind_4\\acid_1&acid_2&acid_3&acid_4\end{bmatrix}
+
\begin{bmatrix}e_1&e_2&e_3&e_4\end{bmatrix}
\end{split}
\end{equation}
This is just the transpose of Form 1.  Work through the matrix algebra to make sure you understand why Equation \ref{eqn:stackloss.form1b} is Equation \ref{eqn:stacklossi} for all the $i$ data points together and why it is equal to the transpose of Equation \ref{eqn:stackloss.form1}.  You'll need the relationship $(\AA\BB)^\top=\BB^\top \AA^\top$.

Let's write Equation \ref{eqn:stackloss.form1b} as $\yy = \DD\dd$, where $\DD$ contains our parameters.  Then we can solve for $\DD$ following the steps in Equation \ref{eqn:stack.loss.derivation} but multiplying from the right instead of from the left.  See if you can work through the steps to show that 
$\dd = \yy\dd^\top(\dd\dd^\top)^{-1}$.

\begin{Schunk}
\begin{Sinput}
 y=matrix(dat$stack.loss, nrow=1)
 d=rbind(1, dat$Air.Flow, dat$Water.Temp, dat$Acid.Conc)
 y%*%t(d)%*%solve(d%*%t(d))
\end{Sinput}
\begin{Soutput}
          [,1]      [,2]     [,3] [,4]
[1,] -524.9048 -1.047619 7.619048    5
\end{Soutput}
\begin{Sinput}
 coef(fit1.mult)
\end{Sinput}
\begin{Soutput}
(Intercept)    Air.Flow  Water.Temp  Acid.Conc. 
-524.904762   -1.047619    7.619048    5.000000 
\end{Soutput}
\end{Schunk}

\section{Form 2}

In this form, we have the explanatory variables in a matrix on the right of our parameter matrix as in Form 1b but we arrange everything a little differently:
\begin{equation}\label{eqn:stackloss.form2}
\begin{bmatrix}stack.loss_1\\stack.loss_2\\stack.loss_3\\stack.loss_4\end{bmatrix}
= 
\begin{bmatrix}
\alpha&\beta&0&0&0\\
\alpha&0&\beta&0&0\\
\alpha&0&0&\beta&0\\
\alpha&0&0&0&\beta
\end{bmatrix}
\begin{bmatrix}1\\air_1\\air_2\\air_3\\air_4\end{bmatrix}
+
\begin{bmatrix}e_1\\e_2\\e_3\\e_4\end{bmatrix}
\end{equation}
Work through the matrix algebra to make sure you understand why Equation \ref{eqn:stackloss.form2} is the same as Equation \ref{eqn:stacklossi} for all the $i$ data points together.

We will write Form 2 succinctly as
\begin{equation}\label{eqn:form2.succinct}
\yy=\ZZ\xx+\ee
\end{equation}

\subsection{Form 2 with multiple explanatory variables}

The $\xx$ is a column vector of the explanatory variables. If we have more explanatory variables, we add them to the column vector at the bottom.  So if we had air flow, water temperature and acid concentration as explanatory variables, $\xx$ looks like
\begin{equation}\label{eqn:ss2.form2}
\begin{bmatrix}1 \\ air_1 \\ air_2 \\ air_3 \\ air_4 \\ water_1 \\ water_2 \\ water_3 \\ water_4 \\ acid_1 \\ acid_2 \\ acid_3 \\ acid_4 \end{bmatrix}
\end{equation}
Add columns to the  $\ZZ$ matrix for each new variable.
\begin{equation}
\begin{bmatrix}
\alpha & \beta_1 & 0 & 0 & 0 & \beta_2 & 0 & 0 & 0 & \beta_3 & 0 & 0 & 0\\
\alpha & 0 & \beta_1 & 0 & 0 & 0 & \beta_2 & 0 & 0 & 0 & \beta_3 & 0 & 0\\
\alpha&0&0&\beta_1&0&0&0&\beta_2&0&0&0&\beta_3&0\\
\alpha&0&0&0&\beta_1&0&0&0&\beta_2&0&0&0&\beta_3
\end{bmatrix}
\end{equation}
The number of rows of $\ZZ$ is always $n$, the number of rows of $\yy$, because the number of rows on the left and right of the equal sign must match.  The number of columns in $\ZZ$ is determined by the size of $\xx$.  If there is an intercept, there is a 1 in $\xx$.  Then each explanatory variable (like air flow and wind) appears $n$ times.  So if the number of explanatory variables is $k$, the number of columns in $\ZZ$ is $1+k \times n$ if there is an intercept term and $k \times n$ if there is not.

\subsection{When does Form 2 arise?}
Form 2 is similar to how multivariate time-series models are typically written for reading by humans (on a whiteboard or paper).  In these models, we see equations like this:
\begin{equation}\label{eqn:ss1}
\begin{bmatrix}y_1\\y_2\\y_3\\y_4\end{bmatrix}_t
= 
\begin{bmatrix}
\beta_a&\beta_b\\
\beta_a&0.1\\
\beta_b&\beta_a\\
0&\beta_a
\end{bmatrix}
\begin{bmatrix}x_1 \\ x_2 \end{bmatrix}_t
+
\begin{bmatrix}e_1\\e_2\\e_3\\e_4\end{bmatrix}_t
\end{equation}
In this case, $\yy_t$ is the set of 4 observations at time $t$ and $\xx_t$ is the set of 2 explanatory variables at time $t$. The $\ZZ$ is showing how we are modeling the effects of $x_1$ and $x_2$ on the $y$s.  Notice that the effects are not consistent across the $x$ and $y$.  This model would not be possible to fit with \verb@lm@ but will be easy to fit with MARSS (and MARSS-Bayes).  

\subsection{Solving for the parameters for Form 2*}\label{solveform2}
\textit{You can just skim this section if you want but make sure you carefully look at the code in \ref{solvecodeform2}. You will need to adapt that for the homework.  Though you will not need any of the math discussed here for the course, this section will help you practice matrix multiplication and will introduce you to `permutation' matrices which will be handy in many other contexts. }

To solve for $\alpha$ and $\beta$, we need our parameters in a column matrix like so $\left[ \begin{smallmatrix}\alpha\\\beta\end{smallmatrix} \right]$.  We do this by rewritting $\ZZ\xx$ in Equation \ref{eqn:form2.succinct} in `vec' form:  if $\ZZ$ is a $n \times m$ matrix and  $\xx$ is a matrix with 1 column and $m$ rows, then $\ZZ\xx = (\xx^\top \otimes \II_n)\vec(\ZZ)$. The symbol $\otimes$ means Kronecker product and just ignore it since you'll never see it again in our course (or google 'kronecker product' if you are curious).   The ``vec'' of a matrix is that matrix rearranged as a single column:
\begin{equation}
\vec \begin{bmatrix}
1&2\\
3&4
\end{bmatrix} = \begin{bmatrix}
1\\3\\2\\4
\end{bmatrix} 
\end{equation}
Notice how you just take each column one by one and stack them under each other.  In R, the vec is 
\begin{Schunk}
\begin{Sinput}
 A=matrix(1:6,nrow=2,byrow=TRUE)
 vecA = matrix(A,ncol=1)
\end{Sinput}
\end{Schunk}
$\II_n$ is a $n \times n$ identity matrix, a diagonal matrix with all 0s on the off-diagonals and all 1s on the diagonal.  In R, this is simply \verb@diag(n)@.

To show how we solve for $\alpha$ and $\beta$, let's use an example with only 3 data points so Equation \ref{eqn:stackloss.form2} becomes:
\begin{equation}\label{eqn:stackloss.form2.small}
\begin{bmatrix}stack.loss_1\\stack.loss_2\\stack.loss_3\end{bmatrix}
= 
\begin{bmatrix}
\alpha&\beta&0&0\\
\alpha&0&\beta&0\\
\alpha&0&0&\beta
\end{bmatrix}
\begin{bmatrix}1\\air_1\\air_2\\air_3\end{bmatrix}
+
\begin{bmatrix}e_1\\e_2\\e_3\end{bmatrix}
\end{equation}
Using $\ZZ\xx = (\xx^\top \otimes \II_n)\vec(\ZZ)$, this means
\begin{equation}
\begin{bmatrix}
\alpha&\beta&0&0\\
\alpha&0&\beta&0\\
\alpha&0&0&\beta
\end{bmatrix}
\begin{bmatrix}1\\air_1\\air_2\\air_3\end{bmatrix}
=\big(\begin{bmatrix}1&air_1&air_2& air_3\end{bmatrix} \otimes \begin{bmatrix}1&0&0\\ 0&1&0 \\ 0&0&1 \end{bmatrix} \bigr)
\begin{bmatrix}
\alpha\\
\alpha\\
\alpha\\
\beta\\
0\\
0\\
0\\
\beta\\
0\\
0\\
0\\
\beta
\end{bmatrix}
\end{equation}
We need to rewrite the $\vec(\ZZ)$ as a `permutation' matrix times $\left[ \begin{smallmatrix}\alpha\\\beta\end{smallmatrix} \right]$:
\begin{equation}
\begin{bmatrix}
\alpha\\
\alpha\\
\alpha\\
\beta\\
0\\
0\\
0\\
\beta\\
0\\
0\\
0\\
\beta
\end{bmatrix}
=
\begin{bmatrix}
1&0\\
1&0\\
1&0\\
0&1\\
0&0\\
0&0\\
0&0\\
0&1\\
0&0\\
0&0\\
0&0\\
0&1\\
\end{bmatrix}
\begin{bmatrix}
\alpha\\
\beta
\end{bmatrix} = \PP\pp
\end{equation}
where $\PP$ is the permutation matrix and $\pp=\left[ \begin{smallmatrix}\alpha\\\beta\end{smallmatrix} \right]$.
Thus,
\begin{equation}
\yy=\ZZ\xx+\ee = (\xx^\top \otimes \II_n)\PP\begin{bmatrix}\alpha\\ \beta\end{bmatrix} = \MM\pp + \ee
\end{equation}
where $\MM=(\xx^\top \otimes \II_n)\PP$.
We can solve for $\pp$, the parameters, using 
$$(\MM^\top\MM)^{-1}\MM^\top\yy$$
as before.  

\subsection{Code to solve for parameters in Form 2}\label{solvecodeform2}
In the homework, you will use the R code in this section to solve for the parameters in Form 2.  Later when you are fitting multivariate time-series models, you will not solve for parameters this way but you will need to both construct $\ZZ$ matrices in R and read $\ZZ$ matrices. The homework will give you practice creating $\ZZ$ matrices in R.

\begin{Schunk}
\begin{Sinput}
 #make your y and x matrices
 y=matrix(dat$stack.loss, ncol=1)
 x=matrix(c(1,dat$Air.Flow),ncol=1)
 #make the Z matrix
 require(MARSS)
 n=nrow(dat) #number of rows in our data file
 k=1
 #Z has n rows and 1 col for intercept, and n cols for the n air data points
 #a list matrix allows us to combine "characters" and numbers
 Z=matrix(list(0),n,k*n+1) 
 Z[,1]="alpha"
 diag(Z[1:n,1+1:n])="beta" 
 #this function creates that permutation matrix for you
 P=MARSS:::convert.model.mat(Z)$free[,,1]
 M=kronecker(t(x),diag(n))%*%P
 solve(t(M)%*%M)%*%t(M)%*%y
\end{Sinput}
\begin{Soutput}
             [,1]
alpha -11.6159170
beta    0.6412918
\end{Soutput}
\begin{Sinput}
 coef(lm(dat$stack.loss ~ dat$Air.Flow))
\end{Sinput}
\begin{Soutput}
 (Intercept) dat$Air.Flow 
 -11.6159170    0.6412918 
\end{Soutput}
\end{Schunk}
Go through this code line by line at the R command line.  Look at \verb@Z@. It is a list matrix that allows you to combine numbers (the 0s) with character string (names of parameters).  Look at the permutation matrix \verb@P@.  Try \verb@MARSS:::convert.model.mat(Z)$free@ and see that it returns a 3D matrix, which is why the \verb@[,,1]@ appears (to get us a 2D matrix).  To use more data points, you can redefine 
\verb@dat@ to say \verb@dat=stackloss@ to use all 21 data points.

\section{Groups of intercepts}

Let's say that the odd numbered plants are in the north and the even numbered are in the south. We want to include this as a factor in our model that affects the intercept.  Let's go back to just having air flow be our explanatory variable.  Now if the plant is in the north our model is
\begin{equation}
stack.loss_i = \alpha_n + \beta air_i + e_i, \text{ where } e_i \sim \N(0,\sigma^2) 
\end{equation}
If the plant is in the south, our model is
\begin{equation}
stack.loss_i = \alpha_s + \beta air_i + e_i, \text{ where } e_i \sim \N(0,\sigma^2) 
\end{equation}
We'll add north/south as a factor called `reg' (region) to our dataframe:
\begin{Schunk}
\begin{Sinput}
 dat = cbind(dat, reg=rep(c("n","s"),n)[1:n])
 dat
\end{Sinput}
\begin{Soutput}
  Air.Flow Water.Temp Acid.Conc. stack.loss reg
1       80         27         89         42   n
2       80         27         88         37   s
3       75         25         90         37   n
4       62         24         87         28   s
\end{Soutput}
\end{Schunk}
And we can easily fit this model with \verb@lm@.
\begin{Schunk}
\begin{Sinput}
 fit2 = lm(stack.loss ~ -1 + Air.Flow + reg, data=dat)
 coef(fit2)
\end{Sinput}
\begin{Soutput}
  Air.Flow       regn       regs 
 0.5358166 -2.0257880 -5.5429799 
\end{Soutput}
\end{Schunk}
The -1 is added to the \verb@lm@ call to get rid of $\alpha$.  We just want the $\alpha_n$ and $\alpha_s$ intercepts coming from our regions.  

\subsection{North/South intercepts in Form 1}

Written in matrix form, Form 1 for this model is
\begin{equation}\label{eqn:stackloss.form1.ns}
\begin{gathered}
\begin{bmatrix}stack.loss_1\\ stack.loss_2\\ stack.loss_3\\ stack.loss_4\end{bmatrix}
= 
\begin{bmatrix}air_1&1&0\\ air_2&0&1 \\air_3&1&0\\air_4&0&1\end{bmatrix}
\begin{bmatrix}\beta \\ \alpha_n \\ \alpha_s \end{bmatrix}
+
\begin{bmatrix}e_1\\e_2\\e_3\\e_4\end{bmatrix}
\end{gathered}
\end{equation}
Notice that odd plants get $\alpha_n$ and even plants get $\alpha_s$.  Use \verb@model.matrix()@ to see that this is the $\ZZ$ matrix that \verb@lm@ formed. Notice the matrix output by \verb@model.matrix@ looks exactly like $\ZZ$ in Equation \ref{eqn:stackloss.form1.ns}.
\begin{Schunk}
\begin{Sinput}
 Z=model.matrix(fit2)
 Z[1:4,]
\end{Sinput}
\begin{Soutput}
  Air.Flow regn regs
1       80    1    0
2       80    0    1
3       75    1    0
4       62    0    1
\end{Soutput}
\end{Schunk}

We can solve for the parameters using $\xx = (\ZZ^\top\ZZ)^{-1}\ZZ^\top\yy$ as we did for Form 1 before by adding on the 1s and 0s columns we see in the $\ZZ$ matrix in Equation \ref{eqn:stackloss.form1.ns}.  We could build this $\ZZ$ using the following R code:
\begin{Schunk}
\begin{Sinput}
 Z=cbind(dat$Air.Flow,c(1,0,1,0),c(0,1,0,1))
 colnames(Z)=c("beta","regn","regs")
\end{Sinput}
\end{Schunk}
Or just use \verb@model.matrix()@.  This will save time when models are more complex.
\begin{Schunk}
\begin{Sinput}
 Z=model.matrix(fit2)
 Z[1:4,]
\end{Sinput}
\begin{Soutput}
  Air.Flow regn regs
1       80    1    0
2       80    0    1
3       75    1    0
4       62    0    1
\end{Soutput}
\end{Schunk}
Now we can solve for the parameters:
\begin{Schunk}
\begin{Sinput}
 y=matrix(dat$stack.loss, ncol=1)
 solve(t(Z)%*%Z)%*%t(Z)%*%y
\end{Sinput}
\begin{Soutput}
               [,1]
Air.Flow  0.5358166
regn     -2.0257880
regs     -5.5429799
\end{Soutput}
\end{Schunk}
Compare to the output from \verb@lm@ and you will see it is the same. 
\begin{Schunk}
\begin{Sinput}
 coef(fit2)
\end{Sinput}
\begin{Soutput}
  Air.Flow       regn       regs 
 0.5358166 -2.0257880 -5.5429799 
\end{Soutput}
\end{Schunk}

\subsection{North/South intercepts in Form 2}\label{nsform2}
We would write this model in Form 2 as
\begin{equation}\label{eqn:stackloss.form2.ns}
\begin{bmatrix}stack.loss_1\\ stack.loss_2\\ stack.loss_3\\ stack.loss_4\end{bmatrix}
= 
\begin{bmatrix}
\alpha_n&\beta&0&0&0\\
\alpha_s&0&\beta&0&0\\
\alpha_n&0&0&\beta&0\\
\alpha_s&0&0&0&\beta
\end{bmatrix}\begin{bmatrix}1\\air_1\\air_2\\air_3\\air_4\end{bmatrix}
+
\begin{bmatrix}e_1\\e_2\\e_3\\e_4\end{bmatrix}=\ZZ\xx+\ee
\end{equation}

To estimate the parameters, we need to be able to write a list matrix that looks like $\ZZ$ in Equation \ref{eqn:stackloss.form2.ns}. We can use the same code we used in Section \ref{solvecodeform2} with $\ZZ$ changed to look like that in Equation \ref{eqn:stackloss.form2.ns}.
\begin{Schunk}
\begin{Sinput}
 y=matrix(dat$stack.loss, ncol=1)
 x=matrix(c(1,dat$Air.Flow),ncol=1)
 n=nrow(dat)
 k=1
 #list matrix allows us to combine numbers and character strings
 Z=matrix(list(0),n,k*n+1)
 Z[seq(1,n,2),1]="alphanorth"
 Z[seq(2,n,2),1]="alphasouth"
 diag(Z[1:n,1+1:n])="beta"
 P=MARSS:::convert.model.mat(Z)$free[,,1]
 M=kronecker(t(x),diag(n))%*%P
 solve(t(M)%*%M)%*%t(M)%*%y
\end{Sinput}
\begin{Soutput}
                 [,1]
alphanorth -2.0257880
alphasouth -5.5429799
beta        0.5358166
\end{Soutput}
\end{Schunk}
Make sure you understand the code used to form the $\ZZ$ matrix.  Also notice that \verb@class(Z[1,3])="numeric"@ while \verb@class(Z[1,2])="character"@.  This is important.  \verb@0@ in R is a number while \verb@"0"@ would be a character (the name of a parameter).

\section{Groups of $\beta$'s}

Now let's say that the plants have different owners, Sue and Aneesh, and we want to have $\beta$ for the air flow effect vary by owner.  If the plant is in the north and owned by Sue, the model is
\begin{equation}
stack.loss_i = \alpha_n + \beta_s air_i + e_i, \text{ where } e_i \sim \N(0,\sigma^2) 
\end{equation}
If it is in the south and owned by Aneesh, the model is
\begin{equation}
stack.loss_i = \alpha_s + \beta_a air_i + e_i, \text{ where } e_i \sim \N(0,\sigma^2) 
\end{equation}
You get the idea.

Now we need to add an operator variable as a factor in our stackloss dataframe. Plants 1,3 are run by Sue and plants 2,4 are run by Aneesh.
\begin{Schunk}
\begin{Sinput}
 dat = cbind(dat, owner=c("s","a"))
 dat
\end{Sinput}
\begin{Soutput}
  Air.Flow Water.Temp Acid.Conc. stack.loss reg owner
1       80         27         89         42   n     s
2       80         27         88         37   s     a
3       75         25         90         37   n     s
4       62         24         87         28   s     a
\end{Soutput}
\end{Schunk}
Since the operator names can be replicated the length of our data set,  R fills in the operator colmun by replicating our string of operator names to the right length, conveniently (or alarmingly).

We can easily fit this model with \verb@lm@ using the ``:'' notation.
\begin{Schunk}
\begin{Sinput}
 coef(lm(stack.loss ~ -1 + Air.Flow:owner + reg, data=dat))
\end{Sinput}
\begin{Soutput}
           regn            regs Air.Flow:ownera 
          -38.0            -3.0             0.5 
Air.Flow:owners 
            1.0 
\end{Soutput}
\end{Schunk}
Notice that we have 4 datapoints and are estimating 4 parameters.  We are not going to be able to estimate any more parameters than data points.  If we want to estimate any more, we'll need to use the fuller stackflow dataset (which has 21 data points).

\subsection{Owner $\beta$'s in Form 1}
Written in Form 1, this model is
\begin{equation}\label{eqn:stackloss.form1.owner}
\begin{bmatrix}stack.loss_1\\ stack.loss_2\\ stack.loss_3\\ stack.loss_4\end{bmatrix}
= 
\begin{bmatrix}1&0&0&air_1\\ 0&1&air_2&0 \\ 1&0&0&air_3\\ 0&1&air_4&0\end{bmatrix}
\begin{bmatrix}\alpha_n \\ \alpha_s \\ \beta_a \\ \beta_s \end{bmatrix}
+
\begin{bmatrix}e_1\\e_2\\e_3\\e_4\end{bmatrix}=\ZZ\xx+\ee
\end{equation}
The air data have been written to the right of the 1s and 0s for north/south intercepts because that is how \verb@lm@ writes this model in Form 1 and I want to duplicate that (for teaching purposes). Also the $\beta$'s are ordered to be alphabetical because \verb@lm@ writes the $\ZZ$ matrix like that.

Now our model is more complicated and using \verb@model.matrix@ to get our $\ZZ$ saves us a lot tedious matrix building.
\begin{Schunk}
\begin{Sinput}
 fit3=lm(stack.loss ~ -1 + Air.Flow:owner + reg, data=dat)
 Z=model.matrix(fit3)
 Z[1:4,]
\end{Sinput}
\begin{Soutput}
  regn regs Air.Flow:ownera Air.Flow:owners
1    1    0               0              80
2    0    1              80               0
3    1    0               0              75
4    0    1              62               0
\end{Soutput}
\end{Schunk}
Notice the matrix output by \verb@model.matrix@ looks exactly like $\ZZ$ in Equation \ref{eqn:stackloss.form1.owner} (ignore the attributes info).  Now we can solve for the parameters:
\begin{Schunk}
\begin{Sinput}
 y=matrix(dat$stack.loss, ncol=1)
 solve(t(Z)%*%Z)%*%t(Z)%*%y
\end{Sinput}
\begin{Soutput}
                 [,1]
regn            -38.0
regs             -3.0
Air.Flow:ownera   0.5
Air.Flow:owners   1.0
\end{Soutput}
\end{Schunk}
Compare to the output from \verb@lm@ and you will see it is the same. 

\subsection{Owner $\beta$'s in Form 2}
To write this model in Form 2, we just add subscripts to the $\beta$'s in our Form 2 $\ZZ$ matrix:
\begin{equation}\label{eqn:stackloss.form2.owners}
\begin{bmatrix}stack.loss_1\\ stack.loss_2\\ stack.loss_3\\ stack.loss_4\end{bmatrix}
= 
\begin{bmatrix}
\alpha_n&\beta_s&0&0&0\\
\alpha_s&0&\beta_a&0&0\\
\alpha_n&0&0&\beta_s&0\\
\alpha_s&0&0&0&\beta_a
\end{bmatrix}\begin{bmatrix}1\\air_1\\air_2\\air_3\\air_4\end{bmatrix}
+
\begin{bmatrix}e_1\\e_2\\e_3\\e_4\end{bmatrix}=\ZZ\xx+\ee
\end{equation}

To estimate the parameters, we change the $\beta$'s in our $\ZZ$ list matrix to have owner designations:
\begin{Schunk}
\begin{Sinput}
 y=matrix(dat$stack.loss, ncol=1)
 x=matrix(c(1,dat$Air.Flow),ncol=1)
 n=nrow(dat)
 k=1
 Z=matrix(list(0),n,k*n+1)
 Z[seq(1,n,2),1]="alpha.n"
 Z[seq(2,n,2),1]="alpha.s"
 diag(Z[1:n,1+1:n])=rep(c("beta.s","beta.a"),n)[1:n]
 P=MARSS:::convert.model.mat(Z)$free[,,1]
 M=kronecker(t(x),diag(n))%*%P
 solve(t(M)%*%M)%*%t(M)%*%y
\end{Sinput}
\begin{Soutput}
         [,1]
alpha.n -38.0
alpha.s  -3.0
beta.s    1.0
beta.a    0.5
\end{Soutput}
\end{Schunk}
The parameters estimates are the same, though $\beta$'s are given in reversed order simply due to the way \verb@convert.model.mat@ is ordering the columns in Form 2's $\ZZ$.

\section{Seasonal effect as a factor}

Let's imagine that the data were taken consecutively in time by quarter.  We want to model the seasonal effect as an intercept change.  We will drop all other effects for now.
If the data were collected in quarter 1, the model is
\begin{equation}\label{eqn:season.i}
stack.loss_i = \alpha_1 + e_i, \text{ where } e_i \sim \N(0,\sigma^2) 
\end{equation}
If collected in quarter 2, the model is
\begin{equation}
stack.loss_i = \alpha_2 + e_i, \text{ where } e_i \sim \N(0,\sigma^2) 
\end{equation}
etc.

We add a column to our dataframe to account for season:
\begin{Schunk}
\begin{Sinput}
 dat = cbind(dat, qtr=paste(rep("qtr",n),1:4,sep=""))
 dat
\end{Sinput}
\begin{Soutput}
  Air.Flow Water.Temp Acid.Conc. stack.loss reg owner  qtr
1       80         27         89         42   n     s qtr1
2       80         27         88         37   s     a qtr2
3       75         25         90         37   n     s qtr3
4       62         24         87         28   s     a qtr4
\end{Soutput}
\end{Schunk}
And we can easily fit this model with \verb@lm@.
\begin{Schunk}
\begin{Sinput}
 coef(lm(stack.loss ~ -1 + qtr, data=dat))
\end{Sinput}
\begin{Soutput}
qtrqtr1 qtrqtr2 qtrqtr3 qtrqtr4 
     42      37      37      28 
\end{Soutput}
\end{Schunk}
The -1 is added to the \verb@lm@ call to get rid of $\alpha$.  We just want the $\alpha_1$, $\alpha_2$, etc. intercepts coming from our quarters.  

For comparison look at 
\begin{Schunk}
\begin{Sinput}
 coef(lm(stack.loss ~ qtr, data=dat))
\end{Sinput}
\begin{Soutput}
(Intercept)     qtrqtr2     qtrqtr3     qtrqtr4 
         42          -5          -5         -14 
\end{Soutput}
\end{Schunk}
Why does it look like that when -1 is missing from the \verb@lm@ call?  Where did the intercept for quarter 1 go and why are the other intercepts so much smaller?

\subsection{Seasonal intercepts written in Form 1}
Remembering that \verb@lm@ puts models in Form 1, look at the $\ZZ$ matrix for Form 1:
\begin{Schunk}
\begin{Sinput}
 fit4=lm(stack.loss ~ -1 + qtr, data=dat)
 Z=model.matrix(fit4)
 Z[1:4,]
\end{Sinput}
\begin{Soutput}
  qtrqtr1 qtrqtr2 qtrqtr3 qtrqtr4
1       1       0       0       0
2       0       1       0       0
3       0       0       1       0
4       0       0       0       1
\end{Soutput}
\end{Schunk}

Written in Form 1, this model is
\begin{equation}\label{eqn:stackloss.form1.season}
\begin{bmatrix}stack.loss_1\\ stack.loss_2\\ stack.loss_3\\ stack.loss_4\end{bmatrix}
= 
\begin{bmatrix}1&0&0&0\\ 0&1&0&0 \\ 0&0&1&0\\ 0&0&0&1\end{bmatrix}
\begin{bmatrix}\alpha_1 \\ \alpha_2 \\ \alpha_3 \\ \alpha_4 \end{bmatrix}
+
\begin{bmatrix}e_1\\e_2\\e_3\\e_4\end{bmatrix}=\ZZ\xx+\ee
\end{equation}


Compare to the model that \verb@lm@ is using when the intercept included.  What does this model look like written in matrix form?
\begin{Schunk}
\begin{Sinput}
 fit5=lm(stack.loss ~ qtr, data=dat)
 Z=model.matrix(fit5)
 Z[1:4,]
\end{Sinput}
\begin{Soutput}
  (Intercept) qtrqtr2 qtrqtr3 qtrqtr4
1           1       0       0       0
2           1       1       0       0
3           1       0       1       0
4           1       0       0       1
\end{Soutput}
\end{Schunk}

\subsection{Seasonal intercepts written in Form 2}
We do not need to add 1s and 0s to our $\ZZ$ matrix in Form 2; we just add subscripts to our intercepts like we did when we had north-south intercepts.  In this model, we do not have any explanatory variables (except intercept) so our $\xx$ is just a $1 \times 1$ matrix:
\begin{equation}\label{eqn:stackloss.form2.season}
\begin{bmatrix}stack.loss_1\\ stack.loss_2\\ stack.loss_3\\ stack.loss_4\end{bmatrix}
= 
\begin{bmatrix}
\alpha_1\\
\alpha_2\\
\alpha_3\\
\alpha_4
\end{bmatrix}\begin{bmatrix}1\end{bmatrix}
+
\begin{bmatrix}e_1\\e_2\\e_3\\e_4\end{bmatrix}=\ZZ\xx+\ee
\end{equation}

\section{* Seasonal effect plus other explanatory variables}
With our 4 data points, we are limited to estimating 4 parameters.  Let's use the full 21 data points so we can estimate some more complex models.  We'll add an owner variable and a quarter variable to the stackloss dataset.

\begin{Schunk}
\begin{Sinput}
 data(stackloss)
 fulldat=stackloss
 n=nrow(fulldat)
 fulldat=cbind(fulldat, 
           owner=rep(c("sue","aneesh","joe"),n)[1:n], 
           qtr=paste("qtr",rep(1:4,n)[1:n],sep=""),
           reg=rep(c("n","s"),n)[1:n])
\end{Sinput}
\end{Schunk}

Let's fit a model where there is only an effect of air flow, but that effect varies by owner and by quarter.  We also want a different intercept for each quarter.  So if datapoint $i$ is from quarter $j$ on a plant owned by owner $k$, the model is
\begin{equation}\label{stackloss.mult.beta}
stack.loss_i = \alpha_j + \beta_{j,k} air_i + e_i
\end{equation}
So there there are $4 \times 3$ $\beta$'s (4 quarters and 3 owners) and 4 $\alpha$'s (4 quarters).

With \verb@lm@, we fit the model as:
\begin{Schunk}
\begin{Sinput}
 fit7 = lm(stack.loss ~ -1 + qtr + Air.Flow:qtr:owner, data=fulldat)
\end{Sinput}
\end{Schunk}

Take a look at $\ZZ$ for Form 1 using \verb@model.matrix(Z)@.  It's not shown since it is large:
\begin{Schunk}
\begin{Sinput}
 model.matrix(fit7)
\end{Sinput}
\end{Schunk}
The $\xx$ will be
$$\begin{bmatrix}\alpha_1 \\ \alpha_2 \\ \alpha_3 \\ \alpha_4 \\ \beta_{1,a} \\ \beta_{2,a} \\ \beta_{3,a} \\ \dots \end{bmatrix}$$

Take a look at the model matrix that \verb@lm@ is using and make sure you understand how $\ZZ\xx$ produces Equation \ref{stackloss.mult.beta}.
\begin{Schunk}
\begin{Sinput}
 Z=model.matrix(fit7)
\end{Sinput}
\end{Schunk}

For Form 2, our $\ZZ$ size doesn't change; number of rows is $n$ (the number data points) and number of columns is 1 (for intercept) plus the number of explanatory variables times $n$.  So in this case, we only have one explanatory variable (air flow) so $\ZZ$ has 1+21 columns.  To allow the intercept to vary by quarter, we use $\alpha_1$ in the rows of $\ZZ$ where the data is from quarter 1, use $\alpha_2$ where the data is from quarter 2, etc.  Similarly we use the appropriate $\beta_{j,k}$ depending on the quarter and owner for that data point.

We could construct $\ZZ$, $\xx$ and $\yy$ for Form 2 using
\begin{Schunk}
\begin{Sinput}
 y=matrix(fulldat$stack.loss, ncol=1)
 x=matrix(c(1,fulldat$Air.Flow),ncol=1)
 n=nrow(fulldat)
 k=1
 Z=matrix(list(0),n,k*n+1)
 #give the intercepts names based on qtr
 Z[,1]=paste(fulldat$qtr)
 #give the betas names based on qtr and owner
 diag(Z[1:n,1+1:n])=paste("beta",fulldat$qtr,fulldat$owner,sep=".")
 P=MARSS:::convert.model.mat(Z)$free[,,1]
 M=kronecker(t(x),diag(n))%*%P
 solve(t(M)%*%M)%*%t(M)%*%y
\end{Sinput}
\end{Schunk}
Note, the estimates are the same as for \verb@lm@ but are not listed in the same order.

Make sure to look at the $\ZZ$ and $\xx$ for the models and that you understand why they look like they do.

\section{* Models with confounded parameters}

Try adding region as another factor in your model along with quarter and fit with \verb@lm@:
\begin{Schunk}
\begin{Sinput}
 coef(lm(stack.loss ~ -1 + Air.Flow + reg + qtr, data=fulldat))
\end{Sinput}
\begin{Soutput}
  Air.Flow       regn       regs    qtrqtr2    qtrqtr3 
  1.066524 -49.024320 -44.831760  -3.066094   3.499428 
   qtrqtr4 
        NA 
\end{Soutput}
\end{Schunk}
The estimate for quarter 1 is gone (actually it was set to 0) and the estimate for quarter 4 is NA.  Look at the $\ZZ$ matrix for Form 1 and see if you can figure out the problem.  Try also writing out the model for the 1st plant and you'll see what part of the problem is and why the estimate for quarter 1 is fixed at 0.  
\begin{Schunk}
\begin{Sinput}
 fit=lm(stack.loss ~ -1 + Air.Flow + reg + qtr, data=fulldat)
 Z=model.matrix(fit)
\end{Sinput}
\end{Schunk}
But why is the estimate for quarter 4 equal to NA?  What if the ordering of north and south regions was different, say 1 through 4 north, 5 through 8 south, 9 through 12 north, etc?
\begin{Schunk}
\begin{Sinput}
 fulldat2=fulldat
 fulldat2$reg2 = rep(c("n","n","n","n","s","s","s","s"),3)[1:21]
 fit=lm(stack.loss ~ Air.Flow + reg2 + qtr, data=fulldat2)
 coef(fit)
\end{Sinput}
\begin{Soutput}
(Intercept)    Air.Flow       reg2s     qtrqtr2     qtrqtr3 
-45.6158421   1.0407975  -3.5754722   0.7329027   3.0389763 
    qtrqtr4 
  3.6960928 
\end{Soutput}
\end{Schunk}
Now an estimate for quarter 4 appears.

The problem is two-fold.  First by having both region and quarter intercepts, we created models where 2 intercepts appear for one $i$ model and we cannot estimate both.  \verb@lm@ helps us out by setting one of the factor effects to 0.  It will chose the first alphabetically. But as we saw with the model where odd numbered plants were north and even numbered were south, we can still have a situation where one of the intercepts is non-identifiable.  \verb@lm@ helps us out by alerting us to the problem by setting one to NA.  

Once you start writing your own Jags code or using MARSS, you will need to make sure that all your parameters are identifiable.  If they are not, your code will simply `chase its tail'.  The code will generally take forever to converge or if you did not try different starting conditions, it may look like it converged but actually the estimates for the confounded parameters are meaningless.   So you will need to think carefully about the model you are fitting and consider if there are multiple parameters measuring the same thing (for example 2 intercept parameters).

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\clearpage
\renewcommand{\rightmark}{}
\section*{Problems}
\addcontentsline{toc}{section}{Problems}

For the homework questions, we will using part of the \verb@airquality@ data set in R.  Load that as
\begin{Schunk}
\begin{Sinput}
 library(datasets)
 data(airquality)
 #remove any rows with NAs omitted.
 airquality=na.omit(airquality)
 #make Month a factor (i.e., the Month number is a name rather than a number)
 airquality$Month=as.factor(airquality$Month)
 #add a region factor
 airquality$region = rep(c("north","south"),60)[1:111]
 #Only use 5 data points for the homework so you can show the matrices easily
 homeworkdat = airquality[1:5,]
\end{Sinput}
\end{Schunk}

\begin{hwenumerate} 

\item Using Form 1 $\yy=\ZZ\xx+\ee$, write the model being fit by this command
\begin{Schunk}
\begin{Sinput}
 fit=lm(Ozone ~ Wind + Temp, data=homeworkdat)
\end{Sinput}
\end{Schunk}

\item Build the $\yy$ and $\ZZ$ matrices for the above model in R and solve for $\xx$ (the parameters).  Show that they match what you get from the first \verb@lm()@ call.

\item If you added -1 to your \verb@lm@ call in question 1, what changes in your model?
\begin{Schunk}
\begin{Sinput}
 fit=lm(Ozone ~ -1 + Wind + Temp, data=homeworkdat)
\end{Sinput}
\end{Schunk}

\item Write the model for question 1 in Form 2. Adapt the code from subsection \ref{solvecodeform2} to solve for the parameters. You will need to contruct new Z, y and x in the code.

\item  Model the ozone data with only a region (north/south) effect:

\begin{Schunk}
\begin{Sinput}
 fit=lm(Ozone ~ -1 + region, data=homeworkdat)
\end{Sinput}
\end{Schunk}

Write this model in Form 1b (not Form 1) show that you can solve for the parameter values you get from the \verb@lm@ call.

\item Write the model in question 5 in Form 2. Show that you can solve for the parameter values you get from the \verb@lm@ call.  Again to do this, you adapt the code from subsection \ref{solvecodeform2}.

\stepcounter{enumi}
\item[\theenumi\**] Write the model below in Form 2.

\begin{Schunk}
\begin{Sinput}
 fit=lm(Ozone ~ Temp:region, data=homeworkdat)
\end{Sinput}
\end{Schunk}
\stepcounter{enumi}
\item[\theenumi\**] Using the airquality dataset with 111 data points, write the model below in Form 2 and solve for the parametes by adapting code from subsection \ref{solvecodeform2}.

\begin{Schunk}
\begin{Sinput}
 fit=lm(Ozone ~ -1 + Temp:region + Month, data=airquality)
\end{Sinput}
\end{Schunk}
\end{hwenumerate}

%\renewcommand{\rightmark}{Homework solutions}

\chapter*{Solutions Chapter \ref{chap:mlr}}
\addcontentsline{toc}{chapter}{Solutions Chapter \ref{chap:mlr}}

\subsection*{Data Set Up}
\begin{Schunk}
\begin{Sinput}
 library(datasets)
 data(airquality)
 #remove any rows with NAs omitted.
 airquality=na.omit(airquality)
 #make Month a factor (i.e., the Month number is a name rather than a number)
 airquality$Month=as.factor(airquality$Month)
 #add a region factor
 airquality$region = rep(c("north","south"),60)[1:111]
 #Only use 5 data points for the homework so you can show the matrices easily
 homeworkdat = airquality[1:5,]
\end{Sinput}
\end{Schunk}


\subsection*{Problem 1}
{\bf Using Form 1 $\mathbf{y}=\mathbf{Z}\mathbf{x}+\mathbf{e}$, write the model being fit by this command}
\begin{Schunk}
\begin{Sinput}
 fit=lm(Ozone ~ Wind + Temp, data=homeworkdat)
\end{Sinput}
\end{Schunk}
The model is $Ozone_i = \alpha + \beta_w Wind_i + \beta_t Temp_i + e_i$.  Form 1 for this model is:
$$
\begin{bmatrix} Ozone_1 \\ Ozone_2  \\ Ozone_3 \\ Ozone_4 \\ Ozone_5 \end{bmatrix}=
\begin{bmatrix} 1 & Wind_1 & Temp_1\\ 1 & Wind_2 & Temp_2 \\ 1 & Wind_3 & Temp_3 \\ 1 & Wind_4 & Temp_4 \\ 1 & Wind_5 & Temp_5 \end{bmatrix}
\begin{bmatrix} \alpha \\ \beta_w \\ \beta_t \end{bmatrix} + 
\begin{bmatrix} e_1 \\ e_2 \\ e_3 \\ e_4 \\ e_5 \end{bmatrix}
$$

\subsection*{Problem 2}
{\bf Build the $\mathbf{y}$ and $\mathbf{Z}$ matrices for the above model in R and solve for $\mathbf{x}$ (the parameters).  Show that they match what you get from the `lm` call.}

Here are the $\mathbf{y}$ and $\mathbf{Z}$. You can see they match the $\mathbf{y}$ and $\mathbf{Z}$ in the equation above:
\begin{Schunk}
\begin{Sinput}
 y=matrix(homeworkdat$Ozone, ncol=1)
 Z=cbind(1, homeworkdat$Wind, homeworkdat$Temp)
 y
\end{Sinput}
\begin{Soutput}
     [,1]
[1,]   41
[2,]   36
[3,]   12
[4,]   18
[5,]   23
\end{Soutput}
\begin{Sinput}
 Z
\end{Sinput}
\begin{Soutput}
     [,1] [,2] [,3]
[1,]    1  7.4   67
[2,]    1  8.0   72
[3,]    1 12.6   74
[4,]    1 11.5   62
[5,]    1  8.6   65
\end{Soutput}
\end{Schunk}
Next we solve for $\mathbf{x}$ and show it matches what we get from 'lm'. This uses the code in section \ref{solveform1}
\begin{Schunk}
\begin{Sinput}
 solve(t(Z)%*%Z)%*%t(Z)%*%y
\end{Sinput}
\begin{Soutput}
           [,1]
[1,] 56.6219201
[2,] -4.9776707
[3,]  0.2538717
\end{Soutput}
\begin{Sinput}
 coef(lm(Ozone ~ Wind + Temp, data=homeworkdat))
\end{Sinput}
\begin{Soutput}
(Intercept)        Wind        Temp 
 56.6219201  -4.9776707   0.2538717 
\end{Soutput}
\end{Schunk}

\subsection*{Problem 3}
{\bf If you added -1 to your 'lm' call in question 1, what changes in your model?}

First run the 'lm' call and see what changed.  The intercept ($\alpha$) is dropped.
\begin{Schunk}
\begin{Sinput}
 fit=lm(Ozone ~ -1 + Wind + Temp, data=homeworkdat)
 fit
\end{Sinput}
\begin{Soutput}
Call:
lm(formula = Ozone ~ -1 + Wind + Temp, data = homeworkdat)

Coefficients:
  Wind    Temp  
-4.650   1.037  
\end{Soutput}
\end{Schunk}

The model is now $Ozone_i = \beta_w Wind_i + \beta_t Temp_i + e_i$.  To get rid of the $\alpha$ we drop the 1s column: 
$$
\begin{bmatrix} Ozone_1 \\ Ozone_2  \\ Ozone_3 \\ Ozone_4 \\ Ozone_5 \end{bmatrix}=
\begin{bmatrix} Wind_1 & Temp_1\\ Wind_2 & Temp_2 \\ Wind_3 & Temp_3 \\ Wind_4 & Temp_4 \\ Wind_5 & Temp_5 \end{bmatrix}
\begin{bmatrix} \beta_w \\ \beta_t \end{bmatrix} + 
\begin{bmatrix} e_1 \\ e_2 \\ e_3 \\ e_4 \\ e_5 \end{bmatrix}
$$


\subsection*{Problem 4, part 1}
{\bf Write the model for question 1 in Form 2.}

In Form 2, $\mathbf{y}=\mathbf{Z}\mathbf{x}+\mathbf{e}$ and the explanatory variables appear in the $\mathbf{x}$ as a column vector (a matrix with one column). So $\mathbf{x}$ looks like this
$$\begin{bmatrix} 1 \\ Wind_1 \\ \dots \\ Wind_5 \\ Temp_1 \\ \dots \\ Temp_5 \end{bmatrix}$$

Once you get that, then you know that $\mathbf{Z}$ is a $5 \times (1+5+5)$ matrix.  The first column of $\mathbf{Z}$ is the $\alpha$.  The next 5 columns of $\mathbf{Z}$ is a $5 \times 5$ diagonal matrix with $\beta_w$ on the diagonal, just like in Equation 1.12.  For the next explanatory variable, Temperature, we tack on another $5 \times 5$ diagonal matrix; this time with $\beta_t$ on the diagonal.  That's all you needed to say for homework; just to show that you figured out what the form of the $\mathbf{y}$, $\mathbf{Z}$ and $\mathbf{x}$ look like.

If you wanted to write it out in math form, you could show $\mathrm{Z}$ as:
$$
\begin{bmatrix} \text{column of} & 5\times5\text{ diagonal matrix}& 5\times5\text{ diagonal matrix} \\
\alpha & \text{with }\beta_w\text{ on the diagonal} & \text{with }\beta_t\text{ on the diagonal} \end{bmatrix}
$$
or
$$
\begin{bmatrix} \alpha & \beta_w & \dots & 0 & \beta_t & \dots & 0 \\
\dots & \dots & \ddots & \dots & \dots & \ddots & \dots \\
\alpha & 0 & \dots & \beta_w & 0 & \dots & \beta_t \end{bmatrix}
$$

\subsection*{Problem 4, part 2}
{\bf Solve for the parameters.} 

To do the 2nd part, you adapt the code from subsection \ref{solveform2} to solve for the parameters. You will need to contruct new $\ZZ$, $\yy$ and $\xx$ in the code. 

The $\mathbf{y}$ and $\mathbf{x}$ are easy:
\begin{Schunk}
\begin{Sinput}
 y=matrix(homeworkdat$Ozone, ncol=1)
 x=matrix(c(1, homeworkdat$Wind, homeworkdat$Temp), ncol=1)
\end{Sinput}
\end{Schunk}

We adapt the code for making $\mathbf{Z}$ from \ref{solveform2}:

\begin{Schunk}
\begin{Sinput}
 #we know that Z is a 5 x (1+5+5) matrix
 #n is the number of data points
 n=5
 #nrows = n; what about ncol?,  ncol is 1 (alpha) + n (Wind) + n (Temp)
 Z=matrix(list(0),n,1+n+n)
 #the first column is alpha
 Z[,1]="alpha"
 #columns 2:112 are a diagonal matrix with betaw on the diagonal
 diag(Z[,2:(n+1)])="betaw"
 #columns 113:223 are a diagonal matrix with betat on the diagonal
 diag(Z[,(n+2):(2*n+1)])="betat"
\end{Sinput}
\end{Schunk}
Now we can solve for $\mathrm{Z}$:
\begin{Schunk}
\begin{Sinput}
 require(MARSS)
 P=MARSS:::convert.model.mat(Z)$free[,,1]
 M=kronecker(t(x),diag(n))%*%P
 solve(t(M)%*%M)%*%t(M)%*%y
\end{Sinput}
\begin{Soutput}
            [,1]
alpha 56.6219201
betaw -4.9776707
betat  0.2538717
\end{Soutput}
\begin{Sinput}
 coef(lm(Ozone ~ Wind + Temp, data=homeworkdat))
\end{Sinput}
\begin{Soutput}
(Intercept)        Wind        Temp 
 56.6219201  -4.9776707   0.2538717 
\end{Soutput}
\end{Schunk}

\subsection*{Problem 5, part 1}
{\bf Model the ozone data with only a region effect.  Write this in Form 1b.} 
 
First make sure you understand what model is being fit by the 'lm' call:
\begin{Schunk}
\begin{Sinput}
 fit=lm(Ozone ~ -1 + region, data=homeworkdat)
 fit
\end{Sinput}
\begin{Soutput}
Call:
lm(formula = Ozone ~ -1 + region, data = homeworkdat)

Coefficients:
regionnorth  regionsouth  
      25.33        27.00  
\end{Soutput}
\end{Schunk}

The model is $Ozone_i = \alpha_j + e_i$
where $j$ is the region the measurement was taken in. This is an intercept (or level) only model where the intercept is determined by the region (north or south). 

We want to write that model in matrix form using Form 1b, $\mathbf{y}=\mathbf{D}\mathbf{d}+\mathbf{e}$.  Eqn \ref{eqn:stackloss.form1.ns} shows you how to do this for Form 1, except we do not have explanatory variables besides region so we do not have a column with something like 'air' in it.  Form 1b is the transpose of Form 1.

Matrix $\mathbf{y}$ is:
  $$\mathbf{y} = \begin{bmatrix} Ozone_1 & Ozone_2 & \dots & Ozone_5\end{bmatrix}$$

Matrix $\mathbf{D}$ is:
  $$\mathbf{D} = \begin{bmatrix} \alpha_n & \alpha_s \end{bmatrix}$$

For $\mathbf{d}$, we need to know that each column of $\mathbf{d}$ is for a different data point $i$ and tells us what region that data point is from.  So $\mathbf{d}$ has 2 rows, one for each region.  If there is a 1 in row 1, it means that data point came from the north.  If there is a 1 in row 2, it means that data point came from the south.

Let's look at the regions 
\begin{Schunk}
\begin{Sinput}
 homeworkdat$region
\end{Sinput}
\begin{Soutput}
[1] "north" "south" "north" "south" "north"
\end{Soutput}
\end{Schunk}

So the first measurement is from the north, next from south, then north, ...  $\mathbf{Z}$ looks like this
$$\begin{bmatrix} 
1&0&1&0&1\\
0&1&0&1&0 
\end{bmatrix}$$

The easy way to figure out $\dd$ is to remember that Form 1b is just the transpose of Form 1, so $\dd = \ZZ^\top$. So let R show you what $\dd$ is:
\begin{Schunk}
\begin{Sinput}
 t(model.matrix(fit))
\end{Sinput}
\begin{Soutput}
            1 2 3 4 7
regionnorth 1 0 1 0 1
regionsouth 0 1 0 1 0
attr(,"assign")
[1] 1 1
attr(,"contrasts")
attr(,"contrasts")$region
[1] "contr.treatment"
\end{Soutput}
\end{Schunk}

\subsection*{Problem 5, part 2}
{\bf Show that you can solve for the parameters.} 

Section \ref{solveform1b} shows you how to solve for the parameters when the model is in form 1b.  We need to make $\mathbf{y}$ and $\mathbf{d}$ in R.

\begin{Schunk}
\begin{Sinput}
 y=matrix(homeworkdat$Ozone, nrow=1)
\end{Sinput}
\end{Schunk}

We could form $\mathbf{d}$ like so
\begin{Schunk}
\begin{Sinput}
 ndatapoints=5
 d=matrix(0,2,ndatapoints)
 for(i in 1:ndatapoints) d[ifelse(airquality$region[i]=="north",1,2),i]=1
\end{Sinput}
\end{Schunk}
or this
\begin{Schunk}
\begin{Sinput}
 d=rbind(
   as.numeric(airquality$region=="north"),
   as.numeric(airquality$region=="south")
 )
\end{Sinput}
\end{Schunk}
or just use the output from our `lm` call since R's 'lm' is forming the $\mathbf{d}$ matrix too:
\begin{Schunk}
\begin{Sinput}
 d=t(model.matrix(fit))
\end{Sinput}
\end{Schunk}

Now we solve for the parameters using the code in section \ref{solveform1b}:
\begin{Schunk}
\begin{Sinput}
 y%*%t(d)%*%solve(d%*%t(d))
\end{Sinput}
\begin{Soutput}
     regionnorth regionsouth
[1,]    25.33333          27
\end{Soutput}
\begin{Sinput}
 coef(lm(Ozone ~ -1 + region, data=homeworkdat))
\end{Sinput}
\begin{Soutput}
regionnorth regionsouth 
   25.33333    27.00000 
\end{Soutput}
\end{Schunk}

\subsection*{Problem 6, part 1}
{\bf Write the model in question 5 in Form 2} 

The reason we had to use a matrix with 1s and 0s to tell our matrix math what $\alpha$ to use is that Form 1 and Form 1b have the parameters appearing once in a column vector or a row vector.  So we need a matrix with 1s and 0s to say 'where' to put the $\alpha$s. 

In Form 2, we can have the parameters just repeat in our matrix.  This is how we'd write the model on the whiteboard.  We'd just have the $\alpha$ (intercept) column have multiple $\alpha$s in it.  Section \ref{nsform2} shows you how to have different intercepts in Form 2.  The model in question 5 is just like in section \ref{nsform2}, but without the `air'.  It just has different monthly intercepts.

The model is:

$$
\begin{bmatrix} Ozone_1 \\ Ozone_2  \\ Ozone_3 \\ Ozone_4 \\ Ozone_5 \end{bmatrix}
= 
\begin{bmatrix}
\alpha_n\\
\alpha_s\\
\alpha_n \\
\alpha_s \\
\alpha_n
\end{bmatrix}\begin{bmatrix}1\end{bmatrix}
+
\begin{bmatrix} e_1\\ e_2\\ e_3 \\ e_4 \\ e_5\end{bmatrix}=\mathbf{Z}\mathbf{x}+\mathbf{e}
$$

\subsection*{Problem 6, part 2}
{\bf Solve for the parameters} 
Solve for the parameters

To do this we write $\mathbf{y}$, $\mathbf{Z}$, and $\mathbf{x}$ in R and use the code in section \ref{solveform2}.

\begin{Schunk}
\begin{Sinput}
 #the number of data points
 n=5
 y=matrix(homeworkdat$Ozone, ncol=1)
 x=matrix(1)
 Z=matrix(paste("alpha",homeworkdat$region, sep="."),ncol=1)
\end{Sinput}
\end{Schunk}

Then we solve for the parameters:
\begin{Schunk}
\begin{Sinput}
 require(MARSS)
 P=MARSS:::convert.model.mat(Z)$free[,,1]
 M=kronecker(t(x),diag(n))%*%P
 solve(t(M)%*%M)%*%t(M)%*%y
\end{Sinput}
\begin{Soutput}
                [,1]
alpha.north 25.33333
alpha.south 27.00000
\end{Soutput}
\begin{Sinput}
 coef(lm(Ozone ~ -1 + region, data=homeworkdat))
\end{Sinput}
\begin{Soutput}
regionnorth regionsouth 
   25.33333    27.00000 
\end{Soutput}
\end{Schunk}

\subsection*{Problem 7}
{\bf Write the model below in Form 2 and solve for the parameters} 
\begin{Schunk}
\begin{Sinput}
 fit=lm(Ozone ~ Temp:region, data=homeworkdat)
\end{Sinput}
\end{Schunk}

The first step is to write out what model is being fit.  The model is 
$$ Ozone_i = \alpha + \beta_n Temp_i + e_i$$
if $i$ is from the north and 
$$ Ozone_i = \alpha + \beta_s Temp_i + e_i$$
if $i$ is from the south. So each region has the same intercept $\alpha$ but we are including a linear temperature effect that is different for each region.

This is just like Equation \ref{eqn:stackloss.form2.owners} but with one $\alpha$:

$$\begin{bmatrix} Ozone_1 \\ Ozone_2  \\ Ozone_3 \\ Ozone_4 \\ Ozone_5 \end{bmatrix}
= 
\begin{bmatrix}
\alpha & \beta_n & 0 & 0 & 0 & 0\\
\alpha & 0 & \beta_s & 0 & 0 & 0\\
\alpha & 0 & 0 & \beta_n & 0 & 0\\
\alpha & 0 & 0 & 0 & \beta_s & 0\\
\alpha & 0 & 0 & 0 & 0 & \beta_n
\end{bmatrix}\begin{bmatrix}1 \\ Temp_1 \\ Temp_2 \\ Temp_3 \\ Temp_4 \\ Temp_5 \end{bmatrix}
+
\begin{bmatrix} e_1\\ e_2\\ \dots \\ e_{111}\end{bmatrix}=\mathbf{Z}\mathbf{x}+\mathbf{e}$$

Solving for this is a matter of writing $\mathbf{y}$, $\mathbf{Z}$, and $\mathbf{x}$ in R.

\begin{Schunk}
\begin{Sinput}
 n=5 #the number of data points
 y=matrix(homeworkdat$Ozone, ncol=1)
 x=matrix(c(1, homeworkdat$Temp),ncol=1)
 #Set up Z; it is 5 x 6
 Z=matrix(list(0),n,n+1)
 #make the alpha column
 Z[,1]="alpha"
 #make the diagonal of columns 2:6 equal to the betas
 diag(Z[,2:(1+n)])=paste("beta",homeworkdat$region, sep=".")
\end{Sinput}
\end{Schunk}

Then we solve for the parameters:
\begin{Schunk}
\begin{Sinput}
 require(MARSS)
 P=MARSS:::convert.model.mat(Z)$free[,,1]
 M=kronecker(t(x),diag(n))%*%P
 solve(t(M)%*%M)%*%t(M)%*%y
\end{Sinput}
\begin{Soutput}
                  [,1]
alpha      23.86230424
beta.north  0.01510679
beta.south  0.05654090
\end{Soutput}
\begin{Sinput}
 coef(lm(Ozone ~ Temp:region, data=homeworkdat))
\end{Sinput}
\begin{Soutput}
     (Intercept) Temp:regionnorth Temp:regionsouth 
     23.86230424       0.01510679       0.05654090 
\end{Soutput}
\end{Schunk}


\subsection*{Problem 8**}
{\bf Using the airquality dataset with 111 data points, write the model below
in Form 2 and solve for the parameters.} 

\begin{Schunk}
\begin{Sinput}
 fit=lm(Ozone ~ -1 + Temp:region + Month, data=airquality)
\end{Sinput}
\end{Schunk}

The first step is to write out what model is being fit.   
$$ Ozone_i = \alpha_j + \beta_k Temp_i + e_i$$
If $i$ is from the $j$-th month, the intercept is $\alpha_j$.  If $i$ is from the north, $beta_k$ is $\beta_n$. If it is from the south, $beta_k$ is $\beta_s$.

Next, let's look at region and Month.
\begin{Schunk}
\begin{Sinput}
 airquality$region[1:10]
\end{Sinput}
\begin{Soutput}
 [1] "north" "south" "north" "south" "north" "south" "north"
 [8] "south" "north" "south"
\end{Soutput}
\begin{Sinput}
 airquality$Month
\end{Sinput}
\begin{Soutput}
  [1] 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 6 6 6
 [28] 6 6 6 6 6 6 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7
 [55] 7 7 7 7 7 8 8 8 8 8 8 8 8 8 8 8 8 8 8 8 8 8 8 8 8 8 8
 [82] 8 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9 9
[109] 9 9 9
Levels: 5 6 7 8 9
\end{Soutput}
\end{Schunk}
Region is alternating north/south and month is grouped.

So in matrix form our model looks like
$$\begin{bmatrix}Ozone_1\\ Ozone_2\\ \dots \\ Ozone_{111}\end{bmatrix}
= 
\begin{bmatrix}
\alpha_5 & \beta_n & 0 &  \dots & 0 & 0\\
\alpha_5 & 0 &\beta_s &  \dots & 0 & 0\\
\dots  & \dots & \dots & \ddots &  \dots & 0\\
\alpha_9& 0 & 0 & \dots &  \beta_s & 0\\
\alpha_9& 0 & 0 & \dots &  0 & \beta_n
\end{bmatrix}\begin{bmatrix}1 \\ Temp_1 \\ Temp_2 \\ \dots \\ Temp_{111} \end{bmatrix}
+
\begin{bmatrix} e_1\\ e_2\\ \dots \\ e_{111}\end{bmatrix}=\mathbf{Z}\mathbf{x}+\mathbf{e}$$

Solving for this is a matter of writing $\mathbf{y}$, $\mathbf{Z}$, and $\mathbf{x}$ in R.  We don't have to create character strings for our parameter names.  We just use the text in our data.frame and use the \verb@paste()@ function.

\begin{Schunk}
\begin{Sinput}
 n=111 #the number of data points
 y=matrix(airquality$Ozone, ncol=1)
 x=matrix(c(1, airquality$Temp),ncol=1)
 #Set up Z; it is 111 x 112
 Z=matrix(list(0),n,n+1)
 #make the alpha column
 Z[,1]=paste("alpha",airquality$Month, sep="")
 #make the diagonal of columns 2:112 equal to the betas
 diag(Z[,2:(1+n)])=paste("beta",airquality$region, sep=".")
\end{Sinput}
\end{Schunk}

Then we solve for the parameters:
\begin{Schunk}
\begin{Sinput}
 require(MARSS)
 P=MARSS:::convert.model.mat(Z)$free[,,1]
 M=kronecker(t(x),diag(n))%*%P
 solve(t(M)%*%M)%*%t(M)%*%y
\end{Sinput}
\begin{Soutput}
                  [,1]
alpha5     -160.254743
alpha6     -187.708278
alpha7     -173.611725
alpha8     -172.152400
alpha9     -181.929911
beta.north    2.790616
beta.south    2.758379
\end{Soutput}
\begin{Sinput}
 coef(lm(Ozone ~ -1 + Temp:region + Month, data=airquality))
\end{Sinput}
\begin{Soutput}
          Month5           Month6           Month7 
     -160.254743      -187.708278      -173.611725 
          Month8           Month9 Temp:regionnorth 
     -172.152400      -181.929911         2.790616 
Temp:regionsouth 
        2.758379 
\end{Soutput}
\end{Schunk}


\bibliography{../tex/Fish507}

\end{document}
